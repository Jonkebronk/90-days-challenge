generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  role          String    @default("client") // "coach" or "client"
  status        String    @default("pending") // "pending", "active", "inactive"
  coachId       String?
  invitationToken String?  @unique
  invitationSentAt DateTime?
  inviteCode    String?   @unique // Golden ticket code (e.g., "GOLD-A7K9-2M4P")
  inviteCodeExpiresAt DateTime? // Code expiration date
  inviteCodeUsedAt DateTime? // When the code was used

  // Extended client info
  firstName     String?
  lastName      String?
  birthdate     DateTime?
  gender        String?
  phone         String?
  countryCode   String?
  country       String?
  language      String?
  tags          String[]
  membershipStartDate DateTime?
  membershipStatus String?
  checkInFrequency String?
  checkInPeriod String?
  checkInDay    String?

  createdAt     DateTime  @default(now())

  accounts      Account[]
  sessions      Session[]
  userProfile   UserProfile?
  nutritionPlan NutritionPlan?
  caloriePlan   CaloriePlan?
  meals         Meal[]
  workoutPlan   WorkoutPlan?
  dailyLogs     DailyLog[]
  workoutLogs   WorkoutLog[]
  knowledgeProgress UserKnowledgeProgress[]
  checkIns      CheckIn[]

  // Coach-Client relationship
  coach         User?     @relation("CoachClients", fields: [coachId], references: [id])
  clients       User[]    @relation("CoachClients")

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// App models
model UserProfile {
  id                 String   @id @default(cuid())
  userId             String   @unique

  // Goals
  primaryGoal        String?  // "build_muscle", "get_fit", "healthy_habits"

  // Physiology
  heightCm           Decimal? @db.Decimal(5, 2)
  currentWeightKg    Decimal? @db.Decimal(5, 2)
  genderAtBirth      String?  // "male", "female", "other"
  activityLevelFree  String?  // "very_low", "low", "medium", "active", "very_active"
  activityLevelWork  String?  // "very_low", "low", "medium", "high"

  // Nutrition
  nutritionNotes     String?  // Free text about food preferences
  allergies          String[] // Array of allergies
  dietaryPreferences String[] // "pescetarian", "vegan", "vegetarian", "halal", "kosher", "no_supplements"
  excludedIngredients String[] // Array of ingredients to exclude
  nutritionMissing   String?  // Additional nutrition info

  // Activity
  trainingDays       String[] // ["MON", "TUE", etc]
  trainingExperience String?  // "beginner", "experienced", "very_experienced"
  trainingDetails    String?  // Details about training experience

  // Lifestyle
  lifestyleNotes     String?  // Final comments before finishing

  onboardingCompleted Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model NutritionPlan {
  id             String   @id @default(cuid())
  userId         String   @unique
  tdee           Decimal  @db.Decimal(7, 2)
  targetCalories Decimal  @db.Decimal(7, 2)
  proteinG       Decimal  @db.Decimal(6, 2)
  carbsG         Decimal  @db.Decimal(6, 2)
  fatG           Decimal  @db.Decimal(6, 2)
  currentPhase   Int      @default(1)
  startDate      DateTime @default(now())
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("nutrition_plans")
}

model FoodItem {
  id                String   @id @default(cuid())
  name              String
  category          String?
  calories          Decimal  @db.Decimal(6, 2)
  proteinG          Decimal  @db.Decimal(5, 2)
  carbsG            Decimal  @db.Decimal(5, 2)
  fatG              Decimal  @db.Decimal(5, 2)
  isVegetarian      Boolean  @default(true)
  isVegan           Boolean  @default(false)
  commonServingSize String?

  mealIngredients MealIngredient[]

  @@map("food_items")
}

model Meal {
  id             String   @id @default(cuid())
  userId         String
  name           String
  mealType       String?
  totalCalories  Decimal? @db.Decimal(7, 2)
  totalProteinG  Decimal? @db.Decimal(6, 2)
  totalCarbsG    Decimal? @db.Decimal(6, 2)
  totalFatG      Decimal? @db.Decimal(6, 2)
  isFavorite     Boolean  @default(false)
  createdAt      DateTime @default(now())

  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  ingredients MealIngredient[]
  mealLogs    MealLog[]

  @@map("meals")
}

model MealIngredient {
  id         String  @id @default(cuid())
  mealId     String
  foodItemId String
  amountG    Decimal @db.Decimal(7, 2)

  meal     Meal     @relation(fields: [mealId], references: [id], onDelete: Cascade)
  foodItem FoodItem @relation(fields: [foodItemId], references: [id])

  @@map("meal_ingredients")
}

model Exercise {
  id              String   @id @default(cuid())
  name            String
  category        String?
  equipmentNeeded String[]
  difficultyLevel String?
  description     String?
  videoUrl        String?
  instructions    String[]

  sessionExercises SessionExercise[]
  exerciseLogs     ExerciseLog[]

  @@map("exercises")
}

model WorkoutPlan {
  id           String   @id @default(cuid())
  userId       String   @unique
  currentPhase Int      @default(1)
  currentWeek  Int      @default(1)

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutSessions  WorkoutSession[]

  @@map("workout_plans")
}

model WorkoutSession {
  id                String  @id @default(cuid())
  workoutPlanId     String
  name              String
  dayOfWeek         Int?
  sessionType       String?
  estimatedDuration Int?

  workoutPlan      WorkoutPlan       @relation(fields: [workoutPlanId], references: [id], onDelete: Cascade)
  sessionExercises SessionExercise[]
  workoutLogs      WorkoutLog[]

  @@map("workout_sessions")
}

model SessionExercise {
  id                String @id @default(cuid())
  workoutSessionId  String
  exerciseId        String
  orderIndex        Int
  sets              Int
  reps              Int?
  restSeconds       Int    @default(60)

  workoutSession WorkoutSession @relation(fields: [workoutSessionId], references: [id], onDelete: Cascade)
  exercise       Exercise       @relation(fields: [exerciseId], references: [id])

  @@map("session_exercises")
}

model DailyLog {
  id          String   @id @default(cuid())
  userId      String
  logDate     DateTime
  weightKg    Decimal? @db.Decimal(5, 2)
  energyLevel Int?
  sleepHours  Decimal? @db.Decimal(3, 1)
  notes       String?
  createdAt   DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  mealLogs MealLog[]

  @@unique([userId, logDate])
  @@map("daily_logs")
}

model MealLog {
  id          String   @id @default(cuid())
  dailyLogId  String
  mealId      String
  mealTime    DateTime @default(now())

  dailyLog DailyLog @relation(fields: [dailyLogId], references: [id], onDelete: Cascade)
  meal     Meal     @relation(fields: [mealId], references: [id])

  @@map("meal_logs")
}

model WorkoutLog {
  id                String   @id @default(cuid())
  userId            String
  workoutSessionId  String?
  completedAt       DateTime @default(now())
  durationMinutes   Int?
  notes             String?

  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutSession  WorkoutSession? @relation(fields: [workoutSessionId], references: [id])
  exerciseLogs    ExerciseLog[]

  @@map("workout_logs")
}

model ExerciseLog {
  id            String  @id @default(cuid())
  workoutLogId  String
  exerciseId    String
  setNumber     Int
  reps          Int?
  weightKg      Decimal? @db.Decimal(5, 2)
  completed     Boolean @default(true)

  workoutLog WorkoutLog @relation(fields: [workoutLogId], references: [id], onDelete: Cascade)
  exercise   Exercise   @relation(fields: [exerciseId], references: [id])

  @@map("exercise_logs")
}

model KnowledgeModule {
  id                String   @id @default(cuid())
  title             String
  slug              String   @unique
  phase             Int?
  weekNumber        Int?
  contentType       String?
  content           String?
  videoUrl          String?
  estimatedDuration Int?
  orderIndex        Int?

  userProgress UserKnowledgeProgress[]

  @@map("knowledge_modules")
}

model UserKnowledgeProgress {
  id          String    @id @default(cuid())
  userId      String
  moduleId    String
  completed   Boolean   @default(false)
  completedAt DateTime?

  user   User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  module KnowledgeModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@map("user_knowledge_progress")
}

model CheckIn {
  id                    String   @id @default(cuid())
  userId                String
  weekNumber            Int?     // Week number in the program

  // Check-in data
  statusUpdate          String?  // "Hur har du haft det sedan din senaste uppdatering?"
  weightKg              Decimal? @db.Decimal(5, 2)
  energyLevel           Int?     // 1-5 stars
  mood                  Int?     // 1-5 (sad to happy)
  dietPlanAdherence     Int?     // 1-5 stars (kostschema anv채ndning)
  workoutPlanAdherence  Int?     // 1-5 stars (tr채ningsschema anv채ndning)
  sleepNotes            String?  // "Hur mycket sover du i genomsnitt per natt?"
  dailySteps            String?  // "Hur m책nga steg tar du vanligtvis per dag?"

  // Progress photos
  photoFront            String?  // URL to front photo
  photoSide             String?  // URL to side photo
  photoBack             String?  // URL to back photo

  createdAt             DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("check_ins")
}

model Lead {
  id          String   @id @default(cuid())
  name        String
  email       String?
  phone       String?
  status      String   @default("new") // "new", "contacted", "in_dialog", "paused", "won", "lost"
  notes       String?
  tags        String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("leads")
}

model File {
  id          String   @id @default(cuid())
  name        String
  description String?
  fileUrl     String
  fileType    String?  // "pdf", "image", "video", etc
  fileSize    Int?     // in bytes
  uploadedBy  String?  // coach id or name
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("files")
}

model Lesson {
  id          String   @id @default(cuid())
  title       String
  subtitle    String?
  content     String   // Rich text content
  coverImage  String?  // URL to cover image
  attachments String[] // URLs to attached files
  videoUrl    String?  // Optional video URL
  audioUrl    String?  // Optional audio URL
  visibility  String   @default("all") // "all", "specific_clients"
  orderIndex  Int?     // For sorting lessons
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("lessons")
}

model CaloriePlan {
  id                    String   @id @default(cuid())
  userId                String   @unique

  // Basic calculations
  weight                Decimal? @db.Decimal(5, 2)
  activityLevel         String?  // "25", "30", "35"
  deficit               Int?     // Calorie deficit per day
  dailySteps            Int?     // Number of steps per day

  // Macro settings
  proteinPerKg          Decimal? @db.Decimal(3, 1) // e.g., 2.0
  fatPerKg              Decimal? @db.Decimal(3, 1) // e.g., 0.7

  // Meal distribution
  numMeals              Int?     // Number of meals per day
  customDistribution    Boolean  @default(false)
  mealCalories          Int[]    // Array of calories per meal

  // Custom macros per meal (stored as JSON)
  customMacros          Json?    // [{protein: 50, fat: 20, carbs: 100}, ...]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("calorie_plans")
}
